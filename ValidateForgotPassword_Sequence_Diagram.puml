@startuml Validate Forgot Password Sequence
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam roundcorner 10
skinparam maxmessagesize 45

title Validate Forgot Password Flow

actor User as user
participant "ValidateForgotPasswordForm" as ui
participant "useValidateForgotPassword\n(React Query)" as hook
participant "authService" as authService
participant "HTTP Client" as httpClient
participant "AuthController" as authController
participant "AuthService" as backend
participant "UserManager" as userManager
participant "DbContext" as dbContext
database "Database" as db
participant "EmailService" as emailService

== Submit OTP ==
user -> ui: Enter OTP & submit
activate ui
ui -> hook: mutate({ email, token })
activate hook
hook -> authService: validateForgotPassword(payload)
activate authService
authService -> httpClient: POST /api/auth/validate-forgot-password
activate httpClient
httpClient -> authController: HTTP POST request
activate authController

authController -> backend: ValidateForgotPasswordAsync(request)
activate backend

backend -> userManager: FindByEmailAsync(email)
activate userManager
userManager -> db: SELECT user by email
activate db
db --> userManager: user or null
deactivate db
userManager --> backend: user
deactivate userManager

backend -> dbContext: Find OTP token (ResetPassword)
activate dbContext
dbContext -> db: SELECT OTP token by userId & token
activate db
db --> dbContext: token or null
deactivate db
dbContext --> backend: token
deactivate dbContext

backend -> backend: Verify token not expired
activate backend
backend -> dbContext: Remove OTP token
activate dbContext
dbContext -> db: DELETE OTP token
activate db
db --> dbContext: ok
deactivate db
dbContext --> backend: ok
deactivate dbContext

backend -> backend: Generate new password (8 chars)
activate backend
backend -> userManager: GeneratePasswordResetTokenAsync(user)
activate userManager
userManager --> backend: resetToken
deactivate userManager

backend -> userManager: ResetPasswordAsync(user, resetToken, newPwd)
activate userManager
userManager --> backend: success
deactivate userManager

backend -> userManager: UpdateSecurityStampAsync(user)
activate userManager
userManager --> backend: ok
deactivate userManager

backend -> dbContext: SaveChangesAsync()
activate dbContext
dbContext -> db: Save changes
activate db
db --> dbContext: ok
deactivate db
dbContext --> backend: ok
deactivate dbContext
deactivate backend

backend -> emailService: SendNewPasswordEmailAsync(email, newPwd)
activate emailService
emailService --> backend: sent
deactivate emailService

backend --> authController: Success
deactivate backend
authController --> httpClient: HTTP 200 OK
deactivate authController
httpClient --> authService: Success
deactivate httpClient
authService --> hook: Success
deactivate authService
hook --> ui: onSuccess -> show success & hide form
deactivate hook
ui --> user: New password emailed
deactivate ui

@enduml

