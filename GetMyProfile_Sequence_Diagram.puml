@startuml Get My Profile Sequence Diagram
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam roundcorner 10
skinparam maxmessagesize 50

title Get My Profile Flow Sequence Diagram

actor User as user
participant "UI Component\n(ProfilePage)" as uiComponent
participant "useMyProfile Hook\n(React Query)" as reactQuery
participant "authService" as authService
participant "HTTP Client" as httpClient
participant "AuthController" as authController
participant "AuthService" as backendAuthService
participant "UserManager" as userManager
participant "HttpContext" as httpContext
database "Database" as database

user -> uiComponent: Navigate to profile page
activate uiComponent

uiComponent -> reactQuery: useMyProfile()
activate reactQuery

reactQuery -> authService: myProfile()
activate authService

authService -> httpClient: GET /api/auth/my-profile\n(with ACCESS_TOKEN cookie)
activate httpClient

httpClient -> authController: HTTP GET /api/auth/my-profile\nCookie: ACCESS_TOKEN=...
activate authController

== Authorization Check ==
note right of authController: [Authorize] attribute\nverifies JWT token from cookie

authController -> backendAuthService: GetMyProfileAsync()
activate backendAuthService

== Get User from JWT Token ==
backendAuthService -> httpContext: Get HttpContext.User\n(from JWT claims)
activate httpContext
httpContext --> backendAuthService: ClaimsPrincipal
deactivate httpContext

backendAuthService -> backendAuthService: Check principal.Identity\n.IsAuthenticated
activate backendAuthService

alt Not authenticated
    backendAuthService -> backendAuthService: Throw ApiException\n"Không được phép truy cập"
    activate backendAuthService
    backendAuthService --> authController: ApiException (401)
    deactivate backendAuthService
    authController --> httpClient: HTTP 401 Unauthorized
    httpClient --> authService: Error response
    authService --> reactQuery: Error
    reactQuery --> uiComponent: Error state
    uiComponent -> user: Show error message
    deactivate uiComponent
    deactivate reactQuery
    deactivate authService
    deactivate httpClient
    deactivate authController
    deactivate backendAuthService
else Authenticated
    deactivate backendAuthService
    
    == Get User Entity ==
    backendAuthService -> userManager: GetUserAsync(principal)
    activate userManager
    userManager -> database: Query user by UserId\n(from JWT claims)
    activate database
    database --> userManager: ApplicationUser entity
    deactivate database
    userManager --> backendAuthService: ApplicationUser
    deactivate userManager
    
    alt User not found
        backendAuthService -> backendAuthService: Throw ApiException\n"Không tìm thấy tài khoản"
        activate backendAuthService
        backendAuthService --> authController: ApiException (401)
        deactivate backendAuthService
        authController --> httpClient: HTTP 401 Unauthorized
        httpClient --> authService: Error response
        authService --> reactQuery: Error
        reactQuery --> uiComponent: Error state
        uiComponent -> user: Show error message
        deactivate uiComponent
        deactivate reactQuery
        deactivate authService
        deactivate httpClient
        deactivate authController
        deactivate backendAuthService
    else User found
        == Get User Roles ==
        backendAuthService -> userManager: GetRolesAsync(user)
        activate userManager
        userManager -> database: Query roles for user\nJOIN UserRoles
        activate database
        database --> userManager: IList<string> roles
        deactivate database
        userManager --> backendAuthService: IList<string> roles
        deactivate userManager
        
        == Map to Response ==
        backendAuthService -> backendAuthService: Map user to MyProfileResponse\nSet Roles property
        activate backendAuthService
        backendAuthService --> authController: MyProfileResponse
        deactivate backendAuthService
        deactivate backendAuthService
        
        authController -> authController: Wrap in ApiResponse\nSuccessResponse(user, "Get my profile successfully")
        activate authController
        authController --> httpClient: HTTP 200 OK\nApiResponse<MyProfileResponse>
        deactivate authController
        deactivate authController
        
        httpClient --> authService: ApiResponse<MyProfileResponse>
        deactivate httpClient
        deactivate httpClient
        
        authService --> reactQuery: ApiResponse<MyProfileResponse>
        deactivate authService
        
        reactQuery -> reactQuery: Cache response\n(staleTime: 60s)
        activate reactQuery
        reactQuery --> uiComponent: Profile data
        deactivate reactQuery
        
        uiComponent -> uiComponent: Set form fields with profile data
        activate uiComponent
        uiComponent --> user: Display profile information
        deactivate uiComponent
    end
end

@enduml

