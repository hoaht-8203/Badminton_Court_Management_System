@startuml Forgot Password Sequence
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam roundcorner 10
skinparam maxmessagesize 45

title Forgot Password Flow

actor User as user
participant "ForgotPasswordForm" as ui
participant "useForgotPassword\n(React Query)" as hook
participant "authService" as authService
participant "HTTP Client" as httpClient
participant "AuthController" as authController
participant "AuthService" as backend
participant "UserManager" as userManager
participant "DbContext" as dbContext
participant "EmailService" as emailService
database "Database" as db

== Submit Email ==
user -> ui: Enter email & click "Gửi"
activate ui
ui -> hook: mutate(email)
activate hook
hook -> authService: forgotPassword(email)
activate authService
authService -> httpClient: POST /api/auth/forgot-password
activate httpClient
httpClient -> authController: HTTP POST request
activate authController

authController -> backend: ForgotPasswordAsync(request)
activate backend

backend -> userManager: FindByEmailAsync(email)
activate userManager
userManager -> db: SELECT user by email
activate db
db --> userManager: user or null
deactivate db
userManager --> backend: user
deactivate userManager

alt User not found
  backend --> authController: ApiException (400)
  authController --> httpClient: HTTP 400
  httpClient --> authService: Error
  authService --> hook: Error
  hook --> ui: onError -> show "Email không tồn tại"
  deactivate ui
  deactivate hook
  deactivate authService
  deactivate httpClient
  deactivate authController
  deactivate backend
else User found
  backend -> dbContext: Insert OTP token (ResetPassword, +10min)
  activate dbContext
  dbContext -> db: INSERT OTP token
  activate db
  db --> dbContext: ok
  deactivate db
  dbContext --> backend: ok
  deactivate dbContext

  backend -> emailService: SendForgotPasswordEmailAsync(email, OTP)
  activate emailService
  emailService --> backend: sent
  deactivate emailService

  backend --> authController: Success
  deactivate backend
  authController --> httpClient: HTTP 200 OK
  deactivate authController
  httpClient --> authService: Success
  deactivate httpClient
  authService --> hook: Success
  deactivate authService
  hook --> ui: onSuccess -> show OTP form
  deactivate hook
  ui --> user: Notify OTP sent
  deactivate ui
end

@enduml

