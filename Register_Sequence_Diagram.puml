@startuml Register Sequence Diagram
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam roundcorner 10
skinparam maxmessagesize 50

title Register (Sign-up) Flow

actor User as user
participant "UI Component\n(RegisterPage)" as registerPage
participant "authService\n(frontend)" as feAuthService
participant "HTTP Client" as httpClient
participant "AuthController" as authController
participant "AuthService\n(backend)" as beAuthService
participant "UserManager" as userManager
participant "DbContext" as dbContext
participant "EmailService" as emailService
participant "Mapper" as mapper
database "Database" as database

user -> registerPage: Fill sign-up form\nemail, username, password, profile info
activate registerPage
registerPage -> registerPage: Client-side validate

registerPage -> feAuthService: signUp(payload)
activate feAuthService

feAuthService -> httpClient: POST /api/auth/sign-up\nRegisterRequest
activate httpClient

httpClient -> authController: HTTP POST /api/auth/sign-up\nRegisterRequest
activate authController

authController -> beAuthService: UserRegisterAsync(request)
deactivate authController
activate beAuthService

== Check duplicates ==
beAuthService -> userManager: FindByEmailAsync(request.Email)
activate userManager
userManager --> beAuthService: exists?
deactivate userManager

alt Email already exists
  beAuthService --> authController: ApiException 400\n"Email hoặc tên đăng nhập đã tồn tại"
  authController --> httpClient: HTTP 400
  httpClient --> feAuthService: Error
  feAuthService --> registerPage: onError
  registerPage -> user: Show duplicate email error
  deactivate beAuthService
  deactivate registerPage
  deactivate feAuthService
  deactivate httpClient
  deactivate authController
else Email not exists
  beAuthService -> userManager: FindByNameAsync(request.UserName)
  activate userManager
  userManager --> beAuthService: exists?
  deactivate userManager

  alt Username exists
    beAuthService --> authController: ApiException 400\n"Tên đăng nhập đã tồn tại"
    authController --> httpClient: HTTP 400
    httpClient --> feAuthService: Error
    feAuthService --> registerPage: onError
    registerPage -> user: Show duplicate username error
    deactivate beAuthService
    deactivate registerPage
    deactivate feAuthService
    deactivate httpClient
    deactivate authController
  else Username ok
    == Create user ==
    beAuthService -> mapper: Map RegisterRequest to ApplicationUser
    activate mapper
    mapper --> beAuthService: ApplicationUser
    deactivate mapper

    beAuthService -> userManager: CreateAsync(user with hashed password)
    activate userManager
    userManager --> beAuthService: IdentityResult
    deactivate userManager

    alt Create failed
      beAuthService --> authController: ApiException 400\n"Đăng ký thất bại"
      authController --> httpClient: HTTP 400
      httpClient --> feAuthService: Error
      feAuthService --> registerPage: onError
      registerPage -> user: Show create error
      deactivate beAuthService
      deactivate registerPage
      deactivate feAuthService
      deactivate httpClient
      deactivate authController
    else Create succeeded
      beAuthService -> userManager: AddToRoleAsync(user, \"User\")
      activate userManager
      userManager --> beAuthService: Success
      deactivate userManager

      == Create customer ==
      beAuthService -> dbContext: Add Customer from user profile
      activate dbContext
      dbContext -> database: INSERT Customer
      activate database
      database --> dbContext: Success
      deactivate database
      dbContext --> beAuthService: Success
      deactivate dbContext

      == Generate email OTP token ==
      beAuthService -> beAuthService: otp = Random(6 digits)
      beAuthService -> dbContext: Add ApplicationUserToken\n(type EmailConfirm, expires 24h)
      activate dbContext
      dbContext -> database: INSERT ApplicationUserToken
      activate database
      database --> dbContext: Success
      deactivate database
      dbContext --> beAuthService: Success
      deactivate dbContext

      beAuthService -> dbContext: SaveChangesAsync()
      activate dbContext
      dbContext -> database: COMMIT
      activate database
      database --> dbContext: Success
      deactivate database
      dbContext --> beAuthService: Success
      deactivate dbContext

      == Send verification email ==
      beAuthService -> emailService: SendVerifyEmailAsync(email, otp)\n(Fire-and-forget)
      activate emailService
      emailService --> beAuthService: Enqueued
      deactivate emailService

      == Build response ==
      beAuthService -> userManager: GetRolesAsync(user)
      activate userManager
      userManager -> database: Query roles
      activate database
      database --> userManager: Roles list
      deactivate database
      userManager --> beAuthService: IList<string>
      deactivate userManager

      beAuthService -> beAuthService: GetUserMembershipInfoAsync(user.Id)
      note right of beAuthService: Fetch membership info\n(not detailed here)

      beAuthService --> authController: CurrentUserResponse
      deactivate beAuthService

      authController -> authController: ApiResponse.Success(null,\n\"Sign-up successfully\")
      activate authController
      authController --> httpClient: HTTP 200 OK\nApiResponse<CurrentUserResponse>
      deactivate authController

      httpClient --> feAuthService: ApiResponse
      deactivate httpClient

      feAuthService --> registerPage: onSuccess\n(return CurrentUserResponse)
      deactivate feAuthService

      registerPage -> user: Show success,\nprompt email verification
      deactivate registerPage
    end
  end
end

@enduml




