@startuml Update Password Sequence Diagram
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam roundcorner 10
skinparam maxmessagesize 45

title Update Password Flow Sequence Diagram

actor User as user
participant "UI Component\n(ProfilePage)" as profilePage
participant "useUpdatePassword Hook\n(React Query)" as updateHook
participant "authService" as authService
participant "HTTP Client" as httpClient
participant "AuthController" as authController
participant "AuthService" as backendAuthService
participant "UserManager" as userManager
participant "HttpContext" as httpContext
participant "DbContext" as dbContext
participant "TokenProcessor" as tokenProcessor
database "Database" as database

user -> profilePage: Fill form & click "Đổi mật khẩu"
activate profilePage

profilePage -> profilePage: Validate form fields
activate profilePage

profilePage -> updateHook: updatePasswordMutation.mutate(payload)
activate updateHook

updateHook -> authService: updatePassword(payload)
activate authService

authService -> httpClient: PUT /api/auth/update-password\nUpdatePasswordRequest\n(with ACCESS_TOKEN & REFRESH_TOKEN cookies)
activate httpClient

httpClient -> authController: HTTP PUT /api/auth/update-password\nUpdatePasswordRequest\nCookies: ACCESS_TOKEN, REFRESH_TOKEN
activate authController

== Authorization Check ==
note right of authController: [Authorize] attribute\nverifies JWT token from cookie

authController -> authController: Get REFRESH_TOKEN from cookies
activate authController
authController -> backendAuthService: UpdatePasswordAsync(request, refreshToken)
deactivate authController
activate backendAuthService

== Get User from JWT Token ==
backendAuthService -> httpContext: Get HttpContext.User\n(from JWT claims)
activate httpContext
httpContext --> backendAuthService: ClaimsPrincipal
deactivate httpContext

backendAuthService -> userManager: GetUserAsync(principal)
activate userManager
userManager -> database: Query user by UserId
activate database
database --> userManager: ApplicationUser
deactivate database
userManager --> backendAuthService: ApplicationUser
deactivate userManager

backendAuthService -> backendAuthService: Check user.Status == Active
activate backendAuthService

alt User Inactive
    backendAuthService --> authController: ApiException (400)
    authController --> httpClient: HTTP 400
    httpClient --> authService: Error
    authService --> updateHook: Error
    updateHook --> profilePage: onError
    profilePage -> user: Show error message
    deactivate profilePage
    deactivate updateHook
    deactivate authService
    deactivate httpClient
    deactivate authController
    deactivate backendAuthService
else User Active
    deactivate backendAuthService
    
    == Change Password ==
    backendAuthService -> userManager: ChangePasswordAsync(user, oldPassword, newPassword)
    activate userManager
    userManager --> backendAuthService: IdentityResult
    deactivate userManager
    
    alt Password change failed
        backendAuthService --> authController: ApiException (400)
        authController --> httpClient: HTTP 400
        httpClient --> authService: Error
        authService --> updateHook: Error
        updateHook --> profilePage: onError
        profilePage -> user: Show error message
        deactivate profilePage
        deactivate updateHook
        deactivate authService
        deactivate httpClient
        deactivate authController
        deactivate backendAuthService
    else Password changed successfully
        == Cleanup Temp Password Tokens ==
        backendAuthService -> dbContext: Remove temp password tokens
        activate dbContext
        dbContext -> database: DELETE ApplicationUserTokens\nWHERE TokenType = TempPassword
        activate database
        database --> dbContext: Success
        deactivate database
        dbContext --> backendAuthService: Success
        deactivate dbContext
        
        == Generate New Tokens ==
        backendAuthService -> userManager: GetRolesAsync(user)
        activate userManager
        userManager -> database: Query roles
        activate database
        database --> userManager: Roles list
        deactivate database
        userManager --> backendAuthService: IList<string> roles
        deactivate userManager
        
        backendAuthService -> tokenProcessor: GenerateJwtToken(user, roles)
        activate tokenProcessor
        tokenProcessor --> backendAuthService: (jwtToken, expirationDateInUtc)
        deactivate tokenProcessor
        
        backendAuthService -> tokenProcessor: GenerateRefreshToken()
        activate tokenProcessor
        tokenProcessor --> backendAuthService: refreshTokenValue
        deactivate tokenProcessor
        
        == Set New Cookies ==
        backendAuthService -> tokenProcessor: WriteAuthTokenAsHttpOnlyCookie\n("ACCESS_TOKEN", jwtToken, expiration)
        activate tokenProcessor
        tokenProcessor -> httpClient: Set-Cookie: ACCESS_TOKEN\nHttpOnly, Secure, SameSite=Strict
        activate httpClient
        httpClient --> tokenProcessor: Cookie set
        deactivate httpClient
        tokenProcessor --> backendAuthService: Cookie written
        deactivate tokenProcessor
        
        backendAuthService -> tokenProcessor: WriteAuthTokenAsHttpOnlyCookie\n("REFRESH_TOKEN", refreshToken, expiration)
        activate tokenProcessor
        tokenProcessor -> httpClient: Set-Cookie: REFRESH_TOKEN\nHttpOnly, Secure, SameSite=Strict
        activate httpClient
        httpClient --> tokenProcessor: Cookie set
        deactivate httpClient
        tokenProcessor --> backendAuthService: Cookie written
        deactivate tokenProcessor
        
        == Update Refresh Token in Database ==
        backendAuthService -> dbContext: Find refresh token by old token value
        activate dbContext
        dbContext -> database: SELECT * FROM ApplicationUserTokens\nWHERE Token = oldRefreshToken\nAND TokenType = RefreshToken
        activate database
        database --> dbContext: ApplicationUserToken
        deactivate database
        dbContext --> backendAuthService: ApplicationUserToken
        deactivate dbContext
        
        backendAuthService -> dbContext: Update token value & expiration\nSaveChangesAsync()
        activate dbContext
        dbContext -> database: UPDATE ApplicationUserTokens\nSET Token = newRefreshToken\nExpiresAtUtc = newExpiration
        activate database
        database --> dbContext: Success
        deactivate database
        dbContext --> backendAuthService: Success
        deactivate dbContext
        
        backendAuthService --> authController: Task.CompletedTask
        deactivate backendAuthService
        
        authController -> authController: Wrap in ApiResponse\nSuccessResponse(null, "Update password successfully")
        activate authController
        authController --> httpClient: HTTP 200 OK\nApiResponse<null>
        deactivate authController
        deactivate authController
        
        httpClient --> authService: ApiResponse<null>
        deactivate httpClient
        deactivate httpClient
        
        authService --> updateHook: ApiResponse<null>
        deactivate authService
        
        updateHook --> profilePage: onSuccess callback
        deactivate updateHook
        
        profilePage -> profilePage: message.success("Đổi mật khẩu thành công!")\npasswordForm.resetFields()
        activate profilePage
        profilePage --> user: Password updated successfully
        deactivate profilePage
    end
end

@enduml

