@startuml Password Management Sequence Diagram
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam roundcorner 10
skinparam maxmessagesize 45

title Password Management Flow\n(Update Password, Forgot Password, Validate Forgot Password)

actor User as user
participant "UI Component\n(ProfilePage)" as profilePage
participant "ForgotPasswordForm" as forgotForm
participant "ValidateForgotPasswordForm" as validateForm
participant "useUpdatePassword Hook\n(React Query)" as updateHook
participant "useForgotPassword Hook\n(React Query)" as forgotHook
participant "useValidateForgotPassword Hook\n(React Query)" as validateHook
participant "authService" as authService
participant "HTTP Client" as httpClient
participant "AuthController" as authController
participant "AuthService" as backendAuthService
participant "UserManager" as userManager
participant "EmailService" as emailService
participant "HttpContext" as httpContext
participant "DbContext" as dbContext
participant "TokenProcessor" as tokenProcessor
database "Database" as database

== Scenario 1: Update Password ==

user -> profilePage: Submit password form
activate profilePage
profilePage -> updateHook: mutate(payload)
activate updateHook
updateHook -> authService: updatePassword(payload)
activate authService
authService -> httpClient: PUT /api/auth/update-password\n(with cookies)
activate httpClient
httpClient -> authController: HTTP PUT request
activate authController
note right of authController: [Authorize] verifies JWT

authController -> backendAuthService: UpdatePasswordAsync(request, refreshToken)
activate backendAuthService
backendAuthService -> userManager: GetUserAsync(principal)
activate userManager
userManager -> database: Query user
activate database
database --> userManager: User
deactivate database
userManager --> backendAuthService: User
deactivate userManager

backendAuthService -> userManager: ChangePasswordAsync(user, oldPwd, newPwd)
activate userManager
userManager --> backendAuthService: Success
deactivate userManager

backendAuthService -> dbContext: Remove temp password tokens
activate dbContext
dbContext -> database: DELETE temp tokens
activate database
database --> dbContext: Done
deactivate database
dbContext --> backendAuthService: Done
deactivate dbContext

backendAuthService -> userManager: GetRolesAsync(user)
activate userManager
userManager --> backendAuthService: Roles
deactivate userManager

backendAuthService -> tokenProcessor: GenerateJwtToken & GenerateRefreshToken
activate tokenProcessor
tokenProcessor --> backendAuthService: (jwtToken, refreshToken)
deactivate tokenProcessor

backendAuthService -> tokenProcessor: WriteCookies(ACCESS_TOKEN, REFRESH_TOKEN)
activate tokenProcessor
tokenProcessor -> httpClient: Set-Cookie headers
activate httpClient
httpClient --> tokenProcessor: Done
deactivate httpClient
tokenProcessor --> backendAuthService: Done
deactivate tokenProcessor

backendAuthService -> dbContext: Update refresh token in DB
activate dbContext
dbContext -> database: UPDATE refresh token
activate database
database --> dbContext: Success
deactivate database
dbContext --> backendAuthService: Success
deactivate dbContext

backendAuthService --> authController: Success
deactivate backendAuthService
authController --> httpClient: HTTP 200 OK
deactivate authController
httpClient --> authService: Success
deactivate httpClient
authService --> updateHook: Success
deactivate authService
updateHook --> profilePage: onSuccess
deactivate updateHook
profilePage -> user: Show success & reset form
deactivate profilePage

== Scenario 2: Forgot Password ==

user -> forgotForm: Submit email
activate forgotForm
forgotForm -> forgotHook: mutate(email)
activate forgotHook
forgotHook -> authService: forgotPassword(email)
activate authService
authService -> httpClient: POST /api/auth/forgot-password
activate httpClient
httpClient -> authController: HTTP POST request
activate authController

authController -> backendAuthService: ForgotPasswordAsync(request)
activate backendAuthService
backendAuthService -> userManager: FindByEmailAsync(email)
activate userManager
userManager -> database: Query user by email
activate database
database --> userManager: User or null
deactivate database
userManager --> backendAuthService: User
deactivate userManager

backendAuthService -> backendAuthService: Generate OTP (6 digits)
activate backendAuthService
backendAuthService -> dbContext: Add ResetPassword token\n(expires in 10min)
activate dbContext
dbContext -> database: INSERT OTP token
activate database
database --> dbContext: Success
deactivate database
dbContext --> backendAuthService: Success
deactivate dbContext
deactivate backendAuthService

backendAuthService -> emailService: SendForgotPasswordEmailAsync(email, OTP)
activate emailService
emailService --> backendAuthService: Email sent
deactivate emailService

backendAuthService --> authController: Success
deactivate backendAuthService
authController --> httpClient: HTTP 200 OK
deactivate authController
httpClient --> authService: Success
deactivate httpClient
authService --> forgotHook: Success
deactivate authService
forgotHook --> forgotForm: onSuccess
deactivate forgotHook
forgotForm -> user: Show OTP form
deactivate forgotForm

== Scenario 3: Validate Forgot Password ==

user -> validateForm: Submit OTP
activate validateForm
validateForm -> validateHook: mutate(email, token)
activate validateHook
validateHook -> authService: validateForgotPassword(email, token)
activate authService
authService -> httpClient: POST /api/auth/validate-forgot-password
activate httpClient
httpClient -> authController: HTTP POST request
activate authController

authController -> backendAuthService: ValidateForgotPasswordAsync(request)
activate backendAuthService
backendAuthService -> userManager: FindByEmailAsync(email)
activate userManager
userManager -> database: Query user
activate database
database --> userManager: User
deactivate database
userManager --> backendAuthService: User
deactivate userManager

backendAuthService -> dbContext: Find ResetPassword token\n(by OTP)
activate dbContext
dbContext -> database: Query OTP token
activate database
database --> dbContext: Token or null
deactivate database
dbContext --> backendAuthService: Token
deactivate dbContext

backendAuthService -> backendAuthService: Verify token not expired
activate backendAuthService
backendAuthService -> dbContext: Remove OTP token
activate dbContext
dbContext -> database: DELETE OTP token
activate database
database --> dbContext: Success
deactivate database
dbContext --> backendAuthService: Success
deactivate dbContext
deactivate backendAuthService

backendAuthService -> backendAuthService: Generate new password (8 chars)
activate backendAuthService
backendAuthService -> userManager: GeneratePasswordResetTokenAsync(user)
activate userManager
userManager --> backendAuthService: Reset token
deactivate userManager

backendAuthService -> userManager: ResetPasswordAsync(user, token, newPwd)
activate userManager
userManager --> backendAuthService: Success
deactivate userManager

backendAuthService -> userManager: UpdateSecurityStampAsync(user)
activate userManager
userManager --> backendAuthService: Success
deactivate userManager

backendAuthService -> dbContext: SaveChangesAsync()
activate dbContext
dbContext -> database: Save changes
activate database
database --> dbContext: Success
deactivate database
dbContext --> backendAuthService: Success
deactivate dbContext
deactivate backendAuthService

backendAuthService -> emailService: SendNewPasswordEmailAsync(email, newPwd)
activate emailService
emailService --> backendAuthService: Email sent
deactivate emailService

backendAuthService --> authController: Success
deactivate backendAuthService
authController --> httpClient: HTTP 200 OK
deactivate authController
httpClient --> authService: Success
deactivate httpClient
authService --> validateHook: Success
deactivate authService
validateHook --> validateForm: onSuccess
deactivate validateHook
validateForm -> user: Show success & hide form
deactivate validateForm

@enduml

