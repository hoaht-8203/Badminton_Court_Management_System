@startuml
title User Booking Court – Business Workflow

' This diagram focuses on business steps the user goes through,
' not the internal code execution order.

start

partition "Người dùng" {
  :Mở trang Homepage và xem lịch trống\n(UserCourtSchedule hiển thị slot sân);
  :Chọn sân, ngày/khung giờ, lặp tuần (nếu có),\nthêm voucher, chọn thanh toán (cọc/đầy đủ);
  :Nhấn \"Đặt sân\" gửi yêu cầu;
}

partition "Hệ thống (API)" {
  :'POST /booking-courts/user/create';
  :Kiểm tra tài khoản đã xác thực email và có hồ sơ khách hàng;
  :Xác thực sân còn hoạt động, không bảo trì/đang dùng/đã xóa;
  :Kiểm tra ngày giờ hợp lệ\n(không đặt quá khứ, Start<End, ngày lặp hợp lệ);
  :Đảm bảo có cấu hình giá cho khung giờ;
  :Rà soát trùng lịch với các booking đã có\n(chỉ chặn nếu Active hoặc PendingPayment chưa hết hạn giữ chỗ);
  :Tạo booking ở trạng thái PendingPayment\nvà đặt thời gian giữ chỗ (HoldMinutes);
  :Sinh các phiên đặt sân (occurrences) cho từng lần lặp;
  :Tính tổng tiền, áp voucher nếu hợp lệ;\nTạo Payment (mặc định chuyển khoản ngân hàng,\ncho phép thanh toán đủ hoặc cọc);
  :Trả về thông tin booking + PaymentId,\nSố tiền phải thanh toán, QR chuyển khoản và thời gian hết hạn giữ chỗ;
}

partition "Email/Thông báo" {
  if (Thanh toán tiền mặt đã Paid) then (Đã thanh toán)
    :Gửi email xác nhận booking (thông tin sân, thời gian, số tiền đã trả);
  else (Chuyển khoản/Pending)
    :Gửi email yêu cầu thanh toán kèm QR Sepay\nvà đếm ngược thời gian giữ chỗ;
  endif
  :Gửi thông báo (SignalR/role) cho lễ tân & quản lý về booking mới;
}

partition "Người dùng" {
  if (Chuyển khoản) then (Trong hạn giữ chỗ)
    :Quét QR và thanh toán;\nThanh toán thành công → hệ thống tự động xác nhận;
  else (Tiền mặt đã trả)
    :Đã nhận email xác nhận;\nKhông cần hành động thêm;
  endif
}

stop

@enduml


