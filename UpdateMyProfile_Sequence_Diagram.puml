@startuml Update My Profile Sequence Diagram
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam roundcorner 10
skinparam maxmessagesize 50

title Update My Profile Flow Sequence Diagram

actor User as user
participant "UI Component\n(ProfilePage)" as uiComponent
participant "useUpdateMyProfile Hook\n(React Query)" as reactQuery
participant "AuthContext" as authContext
participant "authService" as authService
participant "HTTP Client" as httpClient
participant "AuthController" as authController
participant "AuthService" as backendAuthService
participant "UserManager" as userManager
participant "HttpContext" as httpContext
participant "DbContext" as dbContext
database "Database" as database

user -> uiComponent: Fill form & click "LÆ°u"
activate uiComponent

uiComponent -> uiComponent: Validate form fields
activate uiComponent

uiComponent -> reactQuery: updateProfileMutation.mutate(payload)
activate reactQuery

reactQuery -> authService: updateMyProfile(payload)
activate authService

authService -> httpClient: PUT /api/auth/update-my-profile\nUpdateMyProfileRequest\n(with ACCESS_TOKEN cookie)
activate httpClient

httpClient -> authController: HTTP PUT /api/auth/update-my-profile\nUpdateMyProfileRequest\nCookie: ACCESS_TOKEN=...
activate authController

== Authorization Check ==
note right of authController: [Authorize] attribute\nverifies JWT token from cookie

authController -> backendAuthService: UpdateMyProfileAsync(updateMyProfileRequest)
activate backendAuthService

== Get User from JWT Token ==
backendAuthService -> httpContext: Get HttpContext.User\n(from JWT claims)
activate httpContext
httpContext --> backendAuthService: ClaimsPrincipal
deactivate httpContext

backendAuthService -> backendAuthService: Check principal.Identity\n.IsAuthenticated
activate backendAuthService

alt Not authenticated
    backendAuthService --> authController: ApiException (401)
    authController --> httpClient: HTTP 401
    httpClient --> authService: Error
    authService --> reactQuery: Error
    reactQuery --> uiComponent: onError
    uiComponent -> user: Show error
    deactivate uiComponent
    deactivate reactQuery
    deactivate authService
    deactivate httpClient
    deactivate authController
    deactivate backendAuthService
else Authenticated
    deactivate backendAuthService
    
    == Get User Entity ==
    backendAuthService -> userManager: GetUserAsync(principal)
    activate userManager
    userManager -> database: Query user by UserId\n(from JWT claims)
    activate database
    database --> userManager: ApplicationUser entity
    deactivate database
    userManager --> backendAuthService: ApplicationUser
    deactivate userManager
    
    alt User not found
        backendAuthService --> authController: ApiException (401)
        authController --> httpClient: HTTP 401
        httpClient --> authService: Error
        authService --> reactQuery: Error
        reactQuery --> uiComponent: onError
        uiComponent -> user: Show error
        deactivate uiComponent
        deactivate reactQuery
        deactivate authService
        deactivate httpClient
        deactivate authController
        deactivate backendAuthService
    else User found
        backendAuthService -> backendAuthService: Check user.Status == Active
        activate backendAuthService
        
        alt User Inactive
            backendAuthService --> authController: ApiException (400)
            authController --> httpClient: HTTP 400
            httpClient --> authService: Error
            authService --> reactQuery: Error
            reactQuery --> uiComponent: onError
            uiComponent -> user: Show error
            deactivate uiComponent
            deactivate reactQuery
            deactivate authService
            deactivate httpClient
            deactivate authController
            deactivate backendAuthService
        else User Active
            deactivate backendAuthService
            
            == Update User Entity ==
            backendAuthService -> backendAuthService: Map request to user entity
            activate backendAuthService
            backendAuthService -> userManager: UpdateAsync(user)
            activate userManager
            userManager -> database: UPDATE Users
            activate database
            database --> userManager: Success
            deactivate database
            userManager --> backendAuthService: Success
            deactivate userManager
            deactivate backendAuthService
            
            == Sync Customer Entity (if exists) ==
            backendAuthService -> dbContext: Find Customer by UserId
            activate dbContext
            dbContext -> database: SELECT Customer
            activate database
            database --> dbContext: Customer or null
            deactivate database
            dbContext --> backendAuthService: Customer or null
            deactivate dbContext
            
            opt Customer exists
                backendAuthService -> dbContext: Update & SaveChangesAsync()
                activate dbContext
                dbContext -> database: UPDATE Customers
                activate database
                database --> dbContext: Success
                deactivate database
                dbContext --> backendAuthService: Success
                deactivate dbContext
            end
            
            backendAuthService --> authController: Task.CompletedTask
            deactivate backendAuthService
            
            authController -> authController: Wrap in ApiResponse
            activate authController
            authController --> httpClient: HTTP 200 OK
            deactivate authController
            deactivate authController
            
            httpClient --> authService: ApiResponse<null>
            deactivate httpClient
            deactivate httpClient
            
            authService --> reactQuery: ApiResponse<null>
            deactivate authService
            
            == Frontend Cleanup & Refresh ==
            reactQuery -> reactQuery: onSuccess: invalidateQueries\n& onSuccess callback
            activate reactQuery
            reactQuery --> uiComponent: onSuccess callback
            deactivate reactQuery
            
            uiComponent -> uiComponent: Show success message\nrefetch profile\nreset form\nrefresh AuthContext
            activate uiComponent
            note right of uiComponent: 1. message.success()\n2. refetch() profile\n3. resetFields()\n4. refreshCurrentUser()
            uiComponent --> user: Profile updated successfully
            deactivate uiComponent
        end
    end
end

@enduml

