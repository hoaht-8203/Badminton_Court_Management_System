@startuml Logout Sequence Diagram
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam roundcorner 10
skinparam maxmessagesize 50

title Logout Flow Sequence Diagram

actor User as user
participant "UI Component\n(Header/Dropdown)" as uiComponent
participant "AuthContext" as authContext
participant "authService" as authService
participant "HTTP Client" as httpClient
participant "AuthController" as authController
participant "AuthService" as backendAuthService
participant "TokenProcessor" as tokenProcessor

user -> uiComponent: Click "Đăng xuất" menu
activate uiComponent

uiComponent -> authContext: logout()
activate authContext

authContext -> authService: logout()
activate authService

authService -> httpClient: GET /api/auth/logout\n(with ACCESS_TOKEN cookie)
activate httpClient

httpClient -> authController: HTTP GET /api/auth/logout\nCookie: ACCESS_TOKEN=...
activate authController

== Authorization Check ==
note right of authController: [Authorize] attribute\nverifies JWT token from cookie

authController -> backendAuthService: LogoutAsync()
activate backendAuthService

== Delete Cookies ==
backendAuthService -> tokenProcessor: DeleteAuthTokenAsHttpOnlyCookie\n("ACCESS_TOKEN")
activate tokenProcessor
tokenProcessor -> httpClient: Delete-Cookie: ACCESS_TOKEN
activate httpClient
httpClient --> tokenProcessor: Cookie deleted
deactivate httpClient
tokenProcessor --> backendAuthService: Done
deactivate tokenProcessor

backendAuthService -> tokenProcessor: DeleteAuthTokenAsHttpOnlyCookie\n("REFRESH_TOKEN")
activate tokenProcessor
tokenProcessor -> httpClient: Delete-Cookie: REFRESH_TOKEN
activate httpClient
httpClient --> tokenProcessor: Cookie deleted
deactivate httpClient
tokenProcessor --> backendAuthService: Done
deactivate tokenProcessor

backendAuthService --> authController: Task.CompletedTask
deactivate backendAuthService

authController -> authController: Wrap in ApiResponse\nSuccessResponse(null, "Logout successfully")
activate authController
authController --> httpClient: HTTP 200 OK\nApiResponse<null>
deactivate authController
deactivate authController

httpClient --> authService: ApiResponse<null>
deactivate httpClient
deactivate httpClient

authService --> authContext: ApiResponse<null>
deactivate authService

== Cleanup Frontend State ==
authContext -> authContext: setUser(null)
activate authContext
deactivate authContext

authContext -> authContext: router.push("/homepage")
activate authContext
deactivate authContext

authContext --> uiComponent: Success
deactivate authContext

uiComponent --> user: Redirected to homepage\nUser logged out
deactivate uiComponent

alt Error occurs during logout
    authService --> authContext: Error
    deactivate authService
    authContext -> authContext: setUser(null)\n(cleanup anyway)
    activate authContext
    deactivate authContext
    authContext -> authContext: router.push("/homepage")
    activate authContext
    deactivate authContext
    authContext --> uiComponent: Error handled
    deactivate authContext
    uiComponent --> user: Still redirected to homepage
    deactivate uiComponent
end

@enduml

